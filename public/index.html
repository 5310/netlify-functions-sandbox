<body>
<h1>Hullo world, Again!</h1>

<a id='login' href="/.netlify/functions/auth0">Login</a>
<a id='logout' href="/.netlify/functions/auth0logout">Logout</a>
<div id="profile"></div>

<script>
    const parseJWT = (token) => {
        var base64Url = token.split('.')[1]
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/')
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''))
        return JSON.parse(jsonPayload);
    }

    const params = new URLSearchParams(location.search)
    let id_token
    if (params.has('id_token')) {
        id_token = params.get('id_token')
        const access_token = params.get('access_token')
        window.history.replaceState({}, document.title, "/");

        document.cookie = `id_token=${id_token}; Secure;`
        document.cookie = `access_token=${access_token}; Secure; HttpOnly`

        id_token = undefined
    }
    id_token = document.cookie.match(/id_token=(.+);/)?.[1]
    if (id_token) {
        const user_profile = parseJWT(id_token)
        window.auth0_user_profile = user_profile
        console.log(window.auth0_user_profile)

        if (Math.floor(Date.now() / 1000) < window.auth0_user_profile.exp) {        
            document.cookie = `user_id=${user_profile.sub}; Secure`

            document.getElementById('profile').innerHTML = `
                <p>${user_profile.name} [${user_profile.sub}]</p>
                <img src="${user_profile.picture}" />
                ${
                    user_profile.app_metadata.notes.length 
                    ? `<ul>${user_profile.app_metadata.notes.map(note => `<li>${note}</li>`).join('\n')}</ul>` 
                    : '' 
                }
            `;
        } else {
            // TODO: delete cookies
        }
    }
</script>
</body>
  